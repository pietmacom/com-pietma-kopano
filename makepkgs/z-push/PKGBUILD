# Maintainer: MartiMcFly <martimcfly [at] autorisation.de>
# Contributor: C Anthony Risinger
# Contributer: JÃ¶rg Thalheim <joerg@higgsboson.tk>

pkgname='z-push'
pkgver=2.6.0
pkgrel=1
pkgdesc='Open-Source application to synchronize ActiveSync compatible devices such as mobile phones'
groups=(
    'kopano'
)
arch=(
    'any'
     )
url='https://z-push.org/'
license=(
    'AGPL3'
	)
makedepends=(
    # PKGBUILD
    'git'
    'gzip'
	    )
depends=(
    'php'
	)
optional=(
    'nginx'
    'php-fpm'
    'kopano-core' # php-mapi
    )

# template input; name=base-scm
_phpIni="${_basePkgName}.ini"
source=(
    "${pkgname}::git+https://stash.z-hub.io/scm/zp/z-push.git${_sourceBranch}"
    "${_phpIni}"

    "apache.example.conf"
    "htaccess"
    "z-push.ini"
    "z-push.conf"
    "nginx-location.conf"
    "nginx-ssl.example.conf"
    "php-fpm.example.conf"
       )
md5sums=(
    'SKIP'
    'SKIP'

    'SKIP'
    'SKIP'
    'SKIP'
    'SKIP'
    'SKIP'
    'SKIP'
    'SKIP'
	)
install='install'
backup=(
    '${_confDir}/config.php'
    '${_confDir}/nginx-location.conf'
    'etc/php/conf.d/z-push.ini'
    'etc/php/fpm.d/z-push.conf'
	)
options=('!strip')

# template input; name=base-build-webapp
package() {
    # BIN
    mkdir -p ${pkgdir}/${_binDir}
    cp -r ${srcdir}/${pkgname}/src/* \
	${pkgdir}/${_binDir}/
    cp ${srcdir}/htaccess \
	${pkgdir}/${_binDir}/.htaccess
    rm ${pkgdir}/${_binDir}/config.php
    rm ${pkgdir}/${_binDir}/policies.ini
    sed -i -e "s|\('MAPI_SERVER', \).*$|\1'file:///var/run/kopano/server.sock'\);|" \
	${pkgdir}/usr/share/webapps/z-push/backend/kopano/config.php
    _compressStatic ${pkgdir}/${_binDir}

    # SYSTEM-BIN
    mkdir -p ${pkgdir}/usr/bin
    mkCliDelegate "/${_binDir}/z-push-top.php" \
	"${pkgdir}/usr/bin/z-push-top" 
    mkCliDelegate "/${_binDir}/z-push-admin.php" \
	"${pkgdir}/usr/bin/z-push-admin"

    # CONF
    mkdir -p ${pkgdir}/${_confDir}
    cp ${srcdir}/apache.example.conf \
	${pkgdir}/${_confDir}/
    cp ${srcdir}/php-fpm.example.conf \
	${pkgdir}/${_confDir}/
    cp ${srcdir}/nginx-ssl.example.conf \
	${pkgdir}/${_confDir}/
    cp ${srcdir}/nginx-location.conf \
	${pkgdir}/${_confDir}/
    cp ${srcdir}/${pkgname}/src/config.php \
	${pkgdir}/${_confDir}/config.example.php
    cp ${srcdir}/${pkgname}/src/policies.ini \
	${pkgdir}/${_confDir}/policies.ini
    sed -i -e "s|\('BACKEND_PROVIDER', \).*$|\1'BackendKopano'\);|" \
	${pkgdir}/${_confDir}/config.example.php
    ln -s /${_confDir}/config.php \
	${pkgdir}/${_binDir}/config.php
    ln -s /${_confDir}/policies.ini \
	${pkgdir}/${_binDir}/policies.ini

    # PHP
    mkdir -p ${pkgdir}/etc/php/conf.d
    cp ${srcdir}/z-push.ini \
	${pkgdir}/etc/php/conf.d

    # FPM
    mkdir -p ${pkgdir}/etc/php/fpm.d
    cp ${srcdir}/z-push.conf \
	${pkgdir}/etc/php/fpm.d

    # LOG
    mkdir -p ${pkgdir}/${_logDir}
}

mkCliDelegate() {
    _delegation=${1}
    _destinationFile=${2}

    echo '#!/bin/sh' > ${_destinationFile}
    echo -n "${_delegation} \"\$@\"" >> ${_destinationFile}
    chmod +x ${_destinationFile}
}
